name: Broken Link Testing

# Run broken link tests on pull requests and scheduled weekly
on:
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/src/**/*.jsx'
      - 'frontend/src/**/*.js'
      - 'frontend/public/**'
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  test-internal-links:
    runs-on: ubuntu-latest
    name: Test Internal Links
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run internal link tests
        working-directory: ./frontend
        run: npm run test:links:report

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: broken-links-report
          path: frontend/broken-links-report.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('frontend/broken-links-report.json', 'utf8'));
            
            const comment = `## ðŸ”— Broken Link Test Results
            
            âŒ **Test Failed** - Broken links detected
            
            **Summary:**
            - Total Links: ${report.summary.totalLinks}
            - âœ… Working: ${report.summary.workingLinks}
            - âŒ Broken: ${report.summary.brokenLinks}
            - âš ï¸ Warnings: ${report.summary.warnings}
            
            ${report.errors.length > 0 ? `**Errors:**\n${report.errors.map((e, i) => `${i + 1}. ${e}`).join('\n')}` : ''}
            
            Please fix these broken links before merging.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  test-external-links:
    runs-on: ubuntu-latest
    name: Test External Links (Scheduled Only)
    # Only run external link tests on schedule or manual trigger
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run full link tests (internal + external)
        working-directory: ./frontend
        run: npm run test:links:full
        continue-on-error: true

      - name: Upload full test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: broken-links-full-report
          path: frontend/broken-links-full-report.json
          retention-days: 90

      - name: Create issue for broken external links
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('frontend/broken-links-full-report.json', 'utf8'));
            
            if (report.summary.brokenLinks > 0) {
              const brokenExternal = report.externalLinks.filter(l => l.status === 'broken');
              
              const issueBody = `## ðŸ”— Broken External Links Detected
              
              **Test Date:** ${report.timestamp}
              
              **Summary:**
              - Total Links Tested: ${report.summary.totalLinks}
              - âœ… Working: ${report.summary.workingLinks}
              - âŒ Broken: ${report.summary.brokenLinks}
              - âš ï¸ Warnings: ${report.summary.warnings}
              
              ### Broken External Links:
              
              ${brokenExternal.map((link, i) => `
              **${i + 1}. ${link.url}**
              - Found in: ${link.foundIn}
              - Error: ${link.error}
              `).join('\n')}
              
              ### Next Steps:
              
              1. Verify each broken link manually
              2. Update URLs if they have changed
              3. Remove links if services are discontinued
              4. Contact service providers if needed
              
              See [Manual Verification Checklist](../blob/main/MANUAL_LINK_VERIFICATION_CHECKLIST.md) for detailed testing instructions.
              
              ---
              
              ðŸ¤– This issue was automatically created by the broken link testing workflow.`;
              
              // Check if similar issue exists
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'broken-links'
              });
              
              if (issues.length === 0) {
                // Create new issue
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸ”— Broken External Links Detected (${report.summary.brokenLinks} links)`,
                  body: issueBody,
                  labels: ['broken-links', 'bug', 'maintenance']
                });
              } else {
                // Update existing issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issues[0].number,
                  body: `## ðŸ”„ Updated Test Results\n\n${issueBody}`
                });
              }
            }

      - name: Send notification on failure
        if: failure()
        run: |
          echo "::warning::Broken external links detected. Check artifacts for details."
